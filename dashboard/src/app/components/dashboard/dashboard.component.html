<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Task Management</h1>
            @if (currentUser) {
              <p class="text-sm text-gray-600">
                {{ currentUser.email }} - 
                <span class="font-semibold capitalize">{{ currentUser.role?.name }}</span>
              </p>
            }
          </div>
          <button
            (click)="logout()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
          >
            Logout
          </button>
        </div>
      </div>
    </header>
  
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Filters and Actions -->
      <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
        <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
          <!-- Search -->
          <input
            type="text"
            [(ngModel)]="searchQuery"
            (ngModelChange)="onSearchChange()"
            placeholder="Search tasks..."
            class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
  
          <!-- Category Filter -->
          <select
            [(ngModel)]="selectedCategory"
            (ngModelChange)="onCategoryChange()"
            class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">All Categories</option>
            <option value="work">Work</option>
            <option value="personal">Personal</option>
          </select>
        </div>
  
        <!-- Add Task Button -->
        @if (canEdit()) {
          <button
            (click)="openTaskForm()"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 whitespace-nowrap"
          >
            + New Task
          </button>
        }
      </div>
  
      <!-- Task Boards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- To Do Column -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">To Do ({{ todoTasks.length }})</h2>
          <div
            cdkDropList
            #todoList="cdkDropList"
            [cdkDropListData]="todoTasks"
            [cdkDropListConnectedTo]="[inProgressList, doneList]"
            (cdkDropListDropped)="drop($event, 'todo')"
            class="min-h-[200px] space-y-3"
          >
            @for (task of todoTasks; track task.id) {
              <div
                cdkDrag
                class="bg-gray-50 p-4 rounded-md border border-gray-200 hover:shadow-md cursor-move"
              >
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-gray-900">{{ task.title }}</h3>
                  <span 
                    [class]="task.category === 'work' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'"
                    class="text-xs px-2 py-1 rounded"
                  >
                    {{ task.category }}
                  </span>
                </div>
                @if (task.description) {
                  <p class="text-sm text-gray-600 mb-3">{{ task.description }}</p>
                }
                @if (canEdit()) {
                  <div class="flex gap-2">
                    <button
                      (click)="editTask(task)"
                      class="text-sm text-blue-600 hover:text-blue-800"
                    >
                      Edit
                    </button>
                    <button
                      (click)="deleteTask(task)"
                      class="text-sm text-red-600 hover:text-red-800"
                    >
                      Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
  
        <!-- In Progress Column -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">In Progress ({{ inProgressTasks.length }})</h2>
          <div
            cdkDropList
            #inProgressList="cdkDropList"
            [cdkDropListData]="inProgressTasks"
            [cdkDropListConnectedTo]="[todoList, doneList]"
            (cdkDropListDropped)="drop($event, 'in_progress')"
            class="min-h-[200px] space-y-3"
          >
            @for (task of inProgressTasks; track task.id) {
              <div
                cdkDrag
                class="bg-yellow-50 p-4 rounded-md border border-yellow-200 hover:shadow-md cursor-move"
              >
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-gray-900">{{ task.title }}</h3>
                  <span 
                    [class]="task.category === 'work' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'"
                    class="text-xs px-2 py-1 rounded"
                  >
                    {{ task.category }}
                  </span>
                </div>
                @if (task.description) {
                  <p class="text-sm text-gray-600 mb-3">{{ task.description }}</p>
                }
                @if (canEdit()) {
                  <div class="flex gap-2">
                    <button
                      (click)="editTask(task)"
                      class="text-sm text-blue-600 hover:text-blue-800"
                    >
                      Edit
                    </button>
                    <button
                      (click)="deleteTask(task)"
                      class="text-sm text-red-600 hover:text-red-800"
                    >
                      Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
  
        <!-- Done Column -->
        <div class="bg-white rounded-lg shadow p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-700">Done ({{ doneTasks.length }})</h2>
          <div
            cdkDropList
            #doneList="cdkDropList"
            [cdkDropListData]="doneTasks"
            [cdkDropListConnectedTo]="[todoList, inProgressList]"
            (cdkDropListDropped)="drop($event, 'done')"
            class="min-h-[200px] space-y-3"
          >
            @for (task of doneTasks; track task.id) {
              <div
                cdkDrag
                class="bg-green-50 p-4 rounded-md border border-green-200 hover:shadow-md cursor-move"
              >
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-gray-900">{{ task.title }}</h3>
                  <span 
                    [class]="task.category === 'work' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'"
                    class="text-xs px-2 py-1 rounded"
                  >
                    {{ task.category }}
                  </span>
                </div>
                @if (task.description) {
                  <p class="text-sm text-gray-600 mb-3">{{ task.description }}</p>
                }
                @if (canEdit()) {
                  <div class="flex gap-2">
                    <button
                      (click)="editTask(task)"
                      class="text-sm text-blue-600 hover:text-blue-800"
                    >
                      Edit
                    </button>
                    <button
                      (click)="deleteTask(task)"
                      class="text-sm text-red-600 hover:text-red-800"
                    >
                      Delete
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>
    </main>
  
    <!-- Task Form Modal -->
    @if (showTaskForm) {
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <h2 class="text-xl font-bold mb-4">
            {{ editingTask ? 'Edit Task' : 'New Task' }}
          </h2>
  
          <form (ngSubmit)="saveTask()" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Title *
              </label>
              <input
                type="text"
                [(ngModel)]="newTask.title"
                name="title"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
  
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Description
              </label>
              <textarea
                [(ngModel)]="newTask.description"
                name="description"
                rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              ></textarea>
            </div>
  
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Category *
              </label>
              <select
                [(ngModel)]="newTask.category"
                name="category"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="work">Work</option>
                <option value="personal">Personal</option>
              </select>
            </div>
  
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Status *
              </label>
              <select
                [(ngModel)]="newTask.status"
                name="status"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="todo">To Do</option>
                <option value="in_progress">In Progress</option>
                <option value="done">Done</option>
              </select>
            </div>
  
            <div class="flex gap-2 justify-end">
              <button
                type="button"
                (click)="closeTaskForm()"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
              >
                {{ editingTask ? 'Update' : 'Create' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }
  </div>